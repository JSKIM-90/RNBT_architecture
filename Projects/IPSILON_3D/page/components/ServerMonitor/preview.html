<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServerMonitor - Preview (register.js 구조)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1219;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .preview-controls {
            display: flex;
            gap: 12px;
        }

        .preview-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .preview-btn:hover {
            background: #2563eb;
        }

        .preview-btn.warning {
            background: #eab308;
            color: #000;
        }

        .preview-btn.critical {
            background: #ef4444;
        }

        .preview-btn.destroy {
            background: #6b7280;
        }

        .preview-btn.destroy:hover {
            background: #4b5563;
        }

        #popup-host {
            /* Shadow DOM host */
        }

        .instance-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="preview-controls">
        <button class="preview-btn" onclick="showNormal()">Normal Server</button>
        <button class="preview-btn warning" onclick="showWarning()">Warning Server</button>
        <button class="preview-btn critical" onclick="showCritical()">Critical Server</button>
        <button class="preview-btn destroy" onclick="destroyInstance()">Destroy</button>
    </div>
    <div class="instance-info" id="instance-info">Instance: not created</div>

    <div id="popup-host"></div>

    <script>
        // ======================
        // TEMPLATE DATA (publishCode에서 로드되는 것과 동일)
        // ======================
        const htmlCode = `
            <template id="popup-server">
                <div class="popup-overlay">
                    <div class="popup-content">
                        <!-- Header -->
                        <div class="popup-header">
                            <div class="header-info">
                                <h2 class="server-name">-</h2>
                                <span class="server-zone">-</span>
                            </div>
                            <div class="header-actions">
                                <span class="server-status" data-status="normal">Normal</span>
                                <button class="close-btn" type="button" aria-label="Close">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Stats Bar -->
                        <div class="stats-bar">
                            <div class="stat-item">
                                <span class="stat-label">CPU</span>
                                <span class="stat-value server-cpu">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Memory</span>
                                <span class="stat-value server-memory">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Disk</span>
                                <span class="stat-value server-disk">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">OS</span>
                                <span class="stat-value server-os">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Uptime</span>
                                <span class="stat-value server-uptime">-</span>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tab-container">
                            <div class="tab-header">
                                <button class="tab-btn active" data-tab="overview">Overview</button>
                                <button class="tab-btn" data-tab="performance">Performance</button>
                            </div>

                            <!-- Tab: Overview (Table) -->
                            <div class="tab-panel active" data-panel="overview">
                                <div class="table-container"></div>
                            </div>

                            <!-- Tab: Performance (Chart) -->
                            <div class="tab-panel" data-panel="performance">
                                <div class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        `;

        const cssCode = `
            .popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .popup-content {
                background: #1a1f2e;
                border-radius: 12px;
                width: 680px;
                max-width: 90vw;
                max-height: 90vh;
                overflow: hidden;
                box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
                border: 1px solid #2a3142;
                display: flex;
                flex-direction: column;
            }

            .popup-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 24px;
                border-bottom: 1px solid #2a3142;
            }

            .header-info {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .server-name {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #e0e6ed;
            }

            .server-zone {
                font-size: 13px;
                color: #8892a0;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .server-status {
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
                text-transform: capitalize;
            }

            .server-status[data-status="normal"] {
                background: rgba(34, 197, 94, 0.15);
                color: #22c55e;
            }

            .server-status[data-status="warning"] {
                background: rgba(234, 179, 8, 0.15);
                color: #eab308;
            }

            .server-status[data-status="critical"] {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                padding: 0;
                background: transparent;
                border: none;
                border-radius: 6px;
                color: #8892a0;
                cursor: pointer;
                transition: background 0.15s, color 0.15s;
            }

            .close-btn:hover {
                background: #2a3142;
                color: #e0e6ed;
            }

            .stats-bar {
                display: flex;
                justify-content: space-around;
                padding: 16px 24px;
                background: #252b3b;
                border-bottom: 1px solid #2a3142;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .stat-label {
                font-size: 11px;
                color: #8892a0;
                text-transform: uppercase;
            }

            .stat-value {
                font-size: 16px;
                font-weight: 600;
                color: #e0e6ed;
            }

            .tab-container {
                display: flex;
                flex-direction: column;
                flex: 1;
                overflow: hidden;
            }

            .tab-header {
                display: flex;
                padding: 0 24px;
                border-bottom: 1px solid #2a3142;
            }

            .tab-btn {
                padding: 12px 20px;
                background: transparent;
                border: none;
                font-size: 13px;
                font-weight: 500;
                color: #8892a0;
                cursor: pointer;
                position: relative;
                transition: color 0.15s;
            }

            .tab-btn:hover {
                color: #e0e6ed;
            }

            .tab-btn.active {
                color: #3b82f6;
            }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: #3b82f6;
            }

            .tab-panel {
                display: none;
                flex: 1;
                overflow: auto;
            }

            .tab-panel.active {
                display: flex;
                flex-direction: column;
            }

            .table-container {
                flex: 1;
                min-height: 250px;
                overflow: auto;
                padding: 16px;
            }

            /* Tabulator Custom Styles */
            .table-container .tabulator {
                border-radius: 8px;
                font-size: 12px;
            }

            .table-container .tabulator-header {
                border-bottom: 2px solid #3b82f6;
            }

            .table-container .tabulator .tabulator-table {
                background: transparent;
            }

            .table-container .tabulator-row {
                background: transparent !important;
                min-height: 40px;
                height: 40px;
            }

            .chart-container {
                flex: 1;
                min-height: 280px;
                padding: 16px;
            }
        `;

        // ======================
        // MOCK IMPLEMENTATIONS (PopupMixin, WKit, fx)
        // ======================

        // Mock fx (functional utilities)
        const fx = {
            go: (data, ...fns) => fns.reduce((acc, fn) => acc.then ? acc.then(fn) : Promise.resolve(fn(acc)), Promise.resolve(data)),
            each: (fn) => (arr) => { arr.forEach(fn); return arr; }
        };

        // Mock WKit
        const WKit = {
            bind3DEvents: (ctx, events) => console.log('[WKit.bind3DEvents]', Object.keys(events)),
            fetchData: (page, datasetName, param) => {
                console.log('[WKit.fetchData]', datasetName, param);
                return Promise.resolve({ response: { data: getMockData(datasetName) } });
            }
        };

        // Mock data functions
        const mockServerData = {
            normal: { name: 'Server A-1', zone: 'Zone-A', status: 'normal', cpu: 45, memory: 62, disk: 71, os: 'Ubuntu 22.04', uptime: 42 },
            warning: { name: 'Server B-2', zone: 'Zone-B', status: 'warning', cpu: 78, memory: 72, disk: 85, os: 'CentOS 8', uptime: 15 },
            critical: { name: 'Server C-3', zone: 'Zone-C', status: 'critical', cpu: 95, memory: 91, disk: 92, os: 'RHEL 9', uptime: 3 }
        };

        let currentServerStatus = 'normal';

        const mockProcessData = [
            { pid: 1234, name: 'nginx', user: 'www-data', type: 'Web Server', cpu: 15.2, memory: 256, status: 'normal', uptime: '12h 35m' },
            { pid: 2345, name: 'node', user: 'app', type: 'Application', cpu: 28.7, memory: 412, status: 'high', uptime: '5h 12m' },
            { pid: 3456, name: 'postgres', user: 'postgres', type: 'Database', cpu: 8.5, memory: 1024, status: 'normal', uptime: '42d 3h' },
            { pid: 4567, name: 'redis', user: 'redis', type: 'Cache', cpu: 3.2, memory: 128, status: 'normal', uptime: '42d 3h' },
            { pid: 5678, name: 'java', user: 'app', type: 'Application', cpu: 22.1, memory: 2048, status: 'warning', uptime: '8h 45m' },
            { pid: 6789, name: 'python', user: 'app', type: 'Worker', cpu: 5.8, memory: 320, status: 'normal', uptime: '2d 6h' }
        ];

        function generateHistoryData() {
            const timestamps = [];
            const cpu = [];
            const memory = [];
            const now = new Date();

            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 3600000);
                timestamps.push(time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
                const baseCpu = 45 + Math.sin(i / 4) * 15;
                const baseMemory = 60 + Math.sin(i / 6) * 10;
                cpu.push(Math.round((baseCpu + (Math.random() - 0.5) * 20) * 10) / 10);
                memory.push(Math.round((baseMemory + (Math.random() - 0.5) * 15) * 10) / 10);
            }

            return { timestamps, cpu, memory };
        }

        function getMockData(datasetName) {
            switch (datasetName) {
                case 'server': return mockServerData[currentServerStatus];
                case 'serverProcesses': return { processes: mockProcessData };
                case 'serverHistory': return generateHistoryData();
                default: return {};
            }
        }

        // Mock PopupMixin
        const PopupMixin = {
            applyShadowPopupMixin: (ctx, config) => {
                let shadowRoot = null;
                let _chart = null;
                let _table = null;

                ctx.showPopup = () => {
                    const host = ctx.page.element;
                    if (!host.shadowRoot) {
                        shadowRoot = host.attachShadow({ mode: 'open' });
                    } else {
                        shadowRoot = host.shadowRoot;
                        shadowRoot.innerHTML = '';
                    }

                    // Add Tabulator CSS
                    const tabulatorLink = document.createElement('link');
                    tabulatorLink.rel = 'stylesheet';
                    tabulatorLink.href = 'https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css';
                    shadowRoot.appendChild(tabulatorLink);

                    // Add custom styles
                    const style = document.createElement('style');
                    style.textContent = config.getStyles();
                    shadowRoot.appendChild(style);

                    // Add content
                    const content = document.createElement('div');
                    content.innerHTML = config.getHTML();
                    shadowRoot.appendChild(content);

                    ctx._shadowRoot = shadowRoot;
                    config.onCreated?.();
                    console.log('[PopupMixin] Popup shown');
                };

                ctx.hidePopup = () => {
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        console.log('[PopupMixin] Popup hidden');
                    }
                };

                ctx.destroyPopup = () => {
                    if (_chart) { _chart.dispose(); _chart = null; }
                    if (_table) { _table.destroy(); _table = null; }
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        ctx._shadowRoot = null;
                    }
                    console.log('[PopupMixin] Popup destroyed');
                };

                ctx.popupQuery = (sel) => ctx._shadowRoot?.querySelector(sel);
                ctx.popupQueryAll = (sel) => ctx._shadowRoot?.querySelectorAll(sel) || [];
                ctx.bindPopupEvents = (events) => {
                    Object.entries(events).forEach(([eventType, handlers]) => {
                        Object.entries(handlers).forEach(([selector, handler]) => {
                            ctx.popupQueryAll(selector).forEach(el => el.addEventListener(eventType, handler));
                        });
                    });
                };

                // Store references for cleanup
                ctx._getChartRef = () => _chart;
                ctx._setChartRef = (c) => { _chart = c; };
                ctx._getTableRef = () => _table;
                ctx._setTableRef = (t) => { _table = t; };
            },

            applyEChartsMixin: (ctx) => {
                ctx.createChart = (selector) => {
                    const container = ctx.popupQuery(selector);
                    if (container) {
                        const chart = echarts.init(container);
                        ctx._setChartRef(chart);
                        console.log('[EChartsMixin] Chart created');
                    }
                };

                ctx.updateChart = (selector, option) => {
                    let chart = ctx._getChartRef();
                    if (!chart) {
                        const container = ctx.popupQuery(selector);
                        if (container) {
                            chart = echarts.init(container);
                            ctx._setChartRef(chart);
                        }
                    }
                    if (chart) {
                        chart.setOption(option);
                        console.log('[EChartsMixin] Chart updated');
                    }
                };

                ctx.resizeChart = () => {
                    const chart = ctx._getChartRef();
                    if (chart) chart.resize();
                };
            },

            applyTabulatorMixin: (ctx) => {
                ctx.createTable = (selector) => {
                    // Table will be created on update
                    console.log('[TabulatorMixin] Table container registered:', selector);
                };

                ctx.updateTable = (selector, data, options) => {
                    let table = ctx._getTableRef();
                    if (table) {
                        table.destroy();
                    }
                    const container = ctx.popupQuery(selector);
                    if (container) {
                        table = new Tabulator(container, { ...options, data });
                        ctx._setTableRef(table);
                        console.log('[TabulatorMixin] Table updated');
                    }
                };
            }
        };

        // ======================
        // TEMPLATE HELPER (register.js와 동일)
        // ======================
        function extractTemplate(htmlCode, templateId) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlCode, 'text/html');
            const template = doc.querySelector(`template#${templateId}`);
            return template?.innerHTML || '';
        }

        // ======================
        // COMPONENT INSTANCE
        // ======================
        let instance = null;

        function createInstance() {
            if (instance) {
                onInstanceUnLoad.call(instance);
            }

            instance = {
                id: 'preview-server',
                page: { element: document.getElementById('popup-host') },
                properties: { publishCode: { htmlCode, cssCode } },
                setter: { ipsilonAssetInfo: { assetId: 'mock-server-001' } }
            };

            initComponent.call(instance);
            updateInstanceInfo();
        }

        function updateInstanceInfo() {
            const info = document.getElementById('instance-info');
            info.textContent = instance ? `Instance: ${instance.id}` : 'Instance: not created';
        }

        // ======================
        // COMPONENT LIFECYCLE (register.js와 동일한 구조)
        // ======================

        function initComponent() {
            const { bind3DEvents, fetchData } = WKit;
            const { applyShadowPopupMixin, applyEChartsMixin, applyTabulatorMixin } = PopupMixin;

            // ======================
            // 1. 데이터 정의
            // ======================
            const assetId = this.setter.ipsilonAssetInfo.assetId;

            this.datasetInfo = [
                { datasetName: 'server', param: { id: assetId }, render: ['renderServerInfo'] },
                { datasetName: 'serverProcesses', param: { id: assetId }, render: ['renderProcessTable'] },
                { datasetName: 'serverHistory', param: { id: assetId }, render: ['renderPerformanceChart'] }
            ];

            // ======================
            // 2. Data Config (API 필드 매핑)
            // ======================
            this.baseInfoConfig = [
                { key: 'name', selector: '.server-name' },
                { key: 'zone', selector: '.server-zone' },
                { key: 'status', selector: '.server-status', dataAttr: 'status' }
            ];

            this.serverInfoConfig = [
                { key: 'cpu', selector: '.server-cpu', suffix: '%' },
                { key: 'memory', selector: '.server-memory', suffix: '%' },
                { key: 'disk', selector: '.server-disk', suffix: '%' },
                { key: 'os', selector: '.server-os' },
                { key: 'uptime', selector: '.server-uptime', suffix: ' days' }
            ];

            // ======================
            // 3. Table Config - Tabulator 컬럼 정의
            // ======================
            this.tableConfig = {
                selector: '.table-container',
                columns: [
                    { title: 'PID', field: 'pid', widthGrow: 1, hozAlign: 'right' },
                    { title: 'Name', field: 'name', widthGrow: 2 },
                    { title: 'User', field: 'user', widthGrow: 1 },
                    { title: 'Type', field: 'type', widthGrow: 1.5 },
                    {
                        title: 'CPU',
                        field: 'cpu',
                        widthGrow: 1,
                        hozAlign: 'right',
                        formatter: (cell) => {
                            const value = cell.getValue();
                            const color = value > 25 ? '#ef4444' : value > 15 ? '#eab308' : '#22c55e';
                            return `<span style="color: ${color}">${value}%</span>`;
                        }
                    },
                    {
                        title: 'Mem',
                        field: 'memory',
                        widthGrow: 1,
                        hozAlign: 'right',
                        formatter: (cell) => `${cell.getValue()}MB`
                    },
                    {
                        title: 'Status',
                        field: 'status',
                        widthGrow: 1,
                        formatter: (cell) => {
                            const value = cell.getValue();
                            const colors = { high: '#ef4444', warning: '#eab308', normal: '#22c55e' };
                            return `<span style="color: ${colors[value] || '#8892a0'}">${value}</span>`;
                        }
                    },
                    { title: 'Up', field: 'uptime', widthGrow: 1, hozAlign: 'right' }
                ],
                optionBuilder: this._getTableOption.bind(this)
            };

            // ======================
            // 4. Chart Config - ECharts 옵션 빌더 (다중 시리즈)
            // ======================
            this.chartConfig = {
                selector: '.chart-container',
                xKey: 'timestamps',
                series: [
                    { yKey: 'cpu', name: 'CPU', color: '#3b82f6', smooth: true, areaStyle: true },
                    { yKey: 'memory', name: 'Memory', color: '#22c55e', smooth: true, areaStyle: true }
                ],
                optionBuilder: getMultiLineChartOption
            };

            // ======================
            // 5. 렌더링 함수 바인딩
            // ======================
            this.renderServerInfo = renderServerInfo.bind(this, [...this.baseInfoConfig, ...this.serverInfoConfig]);
            this.renderProcessTable = renderProcessTable.bind(this, this.tableConfig);
            this.renderPerformanceChart = renderPerformanceChart.bind(this, this.chartConfig);

            // ======================
            // 6. Public Methods
            // ======================
            this.showDetail = showDetail.bind(this);
            this.hideDetail = hideDetail.bind(this);
            this._switchTab = switchTab.bind(this);
            this._getTableOption = getTableOption.bind(this);

            // ======================
            // 7. 이벤트 발행
            // ======================
            this.customEvents = {
                click: '@serverClicked'
            };

            bind3DEvents(this, this.customEvents);

            // ======================
            // 8. Template Config
            // ======================
            this.templateConfig = {
                popup: 'popup-server',
            };

            // ======================
            // 9. Popup (template 기반 탭)
            // ======================
            this.popupCreatedConfig = {
                chartSelector: '.chart-container',
                tableSelector: '.table-container',
                events: {
                    click: {
                        '.close-btn': () => this.hideDetail(),
                        '.tab-btn': (e) => this._switchTab(e.target.dataset.tab)
                    }
                }
            };

            const { htmlCode, cssCode } = this.properties.publishCode || {};
            this.getPopupHTML = () => extractTemplate(htmlCode || '', this.templateConfig.popup);
            this.getPopupStyles = () => cssCode || '';
            this.onPopupCreated = onPopupCreated.bind(this, this.popupCreatedConfig);

            applyShadowPopupMixin(this, {
                getHTML: this.getPopupHTML,
                getStyles: this.getPopupStyles,
                onCreated: this.onPopupCreated
            });

            applyEChartsMixin(this);
            applyTabulatorMixin(this);

            console.log('[ServerMonitor] Registered:', assetId);
        }

        // ======================
        // PUBLIC METHODS (register.js와 동일)
        // ======================

        function showDetail() {
            this.showPopup();
            this._switchTab('overview');

            fx.go(
                this.datasetInfo,
                fx.each(({ datasetName, param, render }) =>
                    fx.go(
                        WKit.fetchData(this.page, datasetName, param),
                        result => result?.response?.data,
                        data => data && render.forEach(fn => this[fn](data))
                    )
                )
            ).catch(e => {
                console.error('[ServerMonitor]', e);
                this.hidePopup();
            });
        }

        function hideDetail() {
            this.hidePopup();
        }

        function switchTab(tabName) {
            const buttons = this.popupQueryAll('.tab-btn');
            const panels = this.popupQueryAll('.tab-panel');

            buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
            panels.forEach(panel => panel.classList.toggle('active', panel.dataset.panel === tabName));

            // Performance 탭 전환 시 차트 리사이즈
            if (tabName === 'performance') {
                setTimeout(() => this.resizeChart?.(), 10);
            }
        }

        // ======================
        // RENDER FUNCTIONS (register.js와 동일)
        // ======================

        function renderServerInfo(config, data) {
            fx.go(
                config,
                fx.each(({ key, selector, dataAttr, suffix }) => {
                    const el = this.popupQuery(selector);
                    if (!el) return;
                    const value = data[key];
                    el.textContent = suffix ? `${value}${suffix}` : value;
                    dataAttr && (el.dataset[dataAttr] = value);
                })
            );
        }

        function renderProcessTable(config, data) {
            const { optionBuilder } = config;
            const option = optionBuilder(config, data.processes);
            this.updateTable('.table-container', data.processes, option);
        }

        function renderPerformanceChart(config, data) {
            const { optionBuilder, ...chartConfig } = config;
            const option = optionBuilder(chartConfig, data);
            this.updateChart('.chart-container', option);
        }

        // ======================
        // TABLE OPTION BUILDER (register.js와 동일)
        // ======================

        function getTableOption(config, data) {
            return {
                layout: 'fitColumns',
                responsiveLayout: 'collapse',
                height: 250,
                placeholder: 'No processes found',
                initialSort: [{ column: 'cpu', dir: 'desc' }],
                columns: config.columns
            };
        }

        // ======================
        // CHART OPTION BUILDER (register.js와 동일)
        // ======================

        function getMultiLineChartOption(config, data) {
            const { xKey, series: seriesConfig } = config;

            return {
                grid: { left: 45, right: 16, top: 30, bottom: 24 },
                legend: {
                    data: seriesConfig.map(s => s.name),
                    top: 0,
                    textStyle: { color: '#8892a0', fontSize: 11 }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: '#1a1f2e',
                    borderColor: '#2a3142',
                    textStyle: { color: '#e0e6ed', fontSize: 12 }
                },
                xAxis: {
                    type: 'category',
                    data: data[xKey],
                    axisLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { show: false },
                    axisLabel: { color: '#888', fontSize: 10, formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: seriesConfig.map(({ yKey, name, color, smooth, areaStyle }) => ({
                    name,
                    type: 'line',
                    data: data[yKey],
                    smooth,
                    symbol: 'none',
                    lineStyle: { color, width: 2 },
                    areaStyle: areaStyle ? {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: hexToRgba(color, 0.3) },
                                { offset: 1, color: hexToRgba(color, 0) }
                            ]
                        }
                    } : null
                }))
            };
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ======================
        // POPUP LIFECYCLE (register.js와 동일)
        // ======================

        function onPopupCreated({ chartSelector, tableSelector, events }) {
            chartSelector && this.createChart(chartSelector);
            tableSelector && this.createTable(tableSelector);
            events && this.bindPopupEvents(events);
        }

        // ======================
        // DESTROY (destroy.js와 동일한 구조)
        // ======================

        function onInstanceUnLoad() {
            this.destroyPopup();
            console.log('[ServerMonitor] Destroyed:', this.id);
        }

        // ======================
        // PREVIEW CONTROLS
        // ======================

        function showNormal() {
            currentServerStatus = 'normal';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showWarning() {
            currentServerStatus = 'warning';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showCritical() {
            currentServerStatus = 'critical';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function destroyInstance() {
            if (instance) {
                onInstanceUnLoad.call(instance);
                instance = null;
                updateInstanceInfo();
            }
        }
    </script>
</body>
</html>
