<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TemperatureSensor - Preview</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1219;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .preview-controls {
            display: flex;
            gap: 12px;
        }

        .preview-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .preview-btn:hover {
            background: #2563eb;
        }

        .preview-btn.warning {
            background: #eab308;
            color: #000;
        }

        .preview-btn.critical {
            background: #ef4444;
        }

        .preview-btn.destroy {
            background: #6b7280;
        }

        #popup-host {
            /* Shadow DOM host */
        }
    </style>
</head>
<body>
    <div class="preview-controls">
        <button class="preview-btn" onclick="showSensor('normal')">Normal Sensor</button>
        <button class="preview-btn warning" onclick="showSensor('warning')">Warning Sensor</button>
        <button class="preview-btn critical" onclick="showSensor('critical')">Critical Sensor</button>
        <button class="preview-btn destroy" onclick="destroyComponent()">Destroy</button>
    </div>

    <div id="popup-host"></div>

    <script>
        // ======================
        // MOCK: PopupMixin (실제 환경에서는 PopupMixin.js 로드)
        // ======================
        const PopupMixin = {};

        PopupMixin.applyShadowPopupMixin = function(instance, options) {
            const { getHTML, getStyles, onCreated } = options;

            instance._popup = {
                host: null,
                shadowRoot: null,
                eventCleanups: [],
            };

            instance.createPopup = function() {
                if (instance._popup.host) return instance._popup.shadowRoot;

                instance._popup.host = document.createElement('div');
                instance._popup.host.id = `popup-${instance.id}`;
                instance._popup.shadowRoot = instance._popup.host.attachShadow({ mode: 'open' });

                instance._popup.shadowRoot.innerHTML = `
                    <style>${getStyles.call(instance)}</style>
                    ${getHTML.call(instance)}
                `;

                instance.page.element.appendChild(instance._popup.host);

                if (onCreated) {
                    onCreated.call(instance, instance._popup.shadowRoot);
                }

                return instance._popup.shadowRoot;
            };

            instance.showPopup = function() {
                if (!instance._popup.host) {
                    instance.createPopup();
                }
                instance._popup.host.style.display = 'block';
            };

            instance.hidePopup = function() {
                if (instance._popup.host) {
                    instance._popup.host.style.display = 'none';
                }
            };

            instance.popupQuery = function(selector) {
                return instance._popup.shadowRoot?.querySelector(selector);
            };

            instance.popupQueryAll = function(selector) {
                return instance._popup.shadowRoot?.querySelectorAll(selector) || [];
            };

            instance.bindPopupEvents = function(events) {
                Object.entries(events).forEach(([eventType, handlers]) => {
                    const listener = (e) => {
                        Object.entries(handlers).forEach(([selector, handler]) => {
                            if (e.target.closest(selector)) {
                                handler.call(instance, e);
                            }
                        });
                    };

                    instance._popup.shadowRoot.addEventListener(eventType, listener);
                    instance._popup.eventCleanups.push(() => {
                        instance._popup.shadowRoot.removeEventListener(eventType, listener);
                    });
                });
            };

            instance.destroyPopup = function() {
                instance._popup.eventCleanups.forEach(cleanup => cleanup());
                instance._popup.eventCleanups = [];

                if (instance._popup.host) {
                    instance._popup.host.remove();
                    instance._popup.host = null;
                    instance._popup.shadowRoot = null;
                }
            };
        };

        PopupMixin.applyEChartsMixin = function(instance) {
            if (!instance._popup) {
                console.warn('[PopupMixin] applyEChartsMixin requires applyShadowPopupMixin first');
                return;
            }

            instance._popup.charts = new Map();

            instance.createChart = function(selector) {
                if (instance._popup.charts.has(selector)) {
                    return instance._popup.charts.get(selector).chart;
                }

                const container = instance.popupQuery(selector);
                if (!container) {
                    console.warn(`[PopupMixin] Chart container not found: ${selector}`);
                    return null;
                }

                const chart = echarts.init(container);

                const resizeObserver = new ResizeObserver(() => {
                    chart.resize();
                });
                resizeObserver.observe(container);

                instance._popup.charts.set(selector, { chart, resizeObserver });

                return chart;
            };

            instance.getChart = function(selector) {
                return instance._popup.charts.get(selector)?.chart || null;
            };

            instance.updateChart = function(selector, option) {
                const chart = instance.getChart(selector);
                if (!chart) {
                    console.warn(`[PopupMixin] Chart not found: ${selector}`);
                    return;
                }

                try {
                    chart.setOption(option);
                } catch (e) {
                    console.error(`[PopupMixin] Chart setOption error:`, e);
                }
            };

            const originalDestroyPopup = instance.destroyPopup;
            instance.destroyPopup = function() {
                instance._popup.charts.forEach(({ chart, resizeObserver }) => {
                    resizeObserver.disconnect();
                    chart.dispose();
                });
                instance._popup.charts.clear();

                originalDestroyPopup.call(instance);
            };
        };

        // ======================
        // MOCK: WKit (실제 환경에서는 WKit 로드)
        // ======================
        const WKit = {
            bind3DEvents: function(instance, events) {
                // Preview에서는 3D 이벤트 바인딩 생략
                console.log('[WKit] bind3DEvents (skipped in preview)');
            },
            fetchData: function(page, datasetName, param) {
                // Mock 데이터 반환
                return Promise.resolve({
                    response: {
                        data: getMockData(datasetName, param)
                    }
                });
            }
        };

        // ======================
        // MOCK: fx (실제 환경에서는 fx 로드)
        // ======================
        const fx = {
            go: function(...args) {
                let result = args[0];
                for (let i = 1; i < args.length; i++) {
                    if (result instanceof Promise) {
                        result = result.then(args[i]);
                    } else {
                        result = args[i](result);
                    }
                }
                return result instanceof Promise ? result : Promise.resolve(result);
            },
            each: function(fn) {
                return function(arr) {
                    return Promise.all(arr.map(fn));
                };
            }
        };

        // ======================
        // MOCK DATA
        // ======================
        const mockSensorData = {
            normal: {
                name: 'Temperature Sensor A-1',
                zone: 'Zone-A',
                status: 'normal',
                temperature: 24.5,
                humidity: 45
            },
            warning: {
                name: 'Temperature Sensor B-2',
                zone: 'Zone-B',
                status: 'warning',
                temperature: 29.8,
                humidity: 62
            },
            critical: {
                name: 'Temperature Sensor C-3',
                zone: 'Zone-C',
                status: 'critical',
                temperature: 36.2,
                humidity: 78
            }
        };

        let currentStatus = 'normal';

        function getMockData(datasetName, param) {
            if (datasetName === 'sensor') {
                return mockSensorData[currentStatus];
            }
            if (datasetName === 'sensorHistory') {
                return generateHistoryData();
            }
            return null;
        }

        function generateHistoryData() {
            const timestamps = [];
            const temperatures = [];
            const now = new Date();

            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 3600000);
                timestamps.push(time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
                const baseTemp = 23 + Math.sin(i / 6) * 2;
                const noise = (Math.random() - 0.5) * 3;
                temperatures.push(Math.round((baseTemp + noise) * 10) / 10);
            }

            return { timestamps, temperatures };
        }

        // ======================
        // TEMPLATE DATA (publishCode 시뮬레이션)
        // ======================
        const htmlCode = `
            <template id="popup-sensor">
                <div class="popup-overlay">
                    <div class="popup-content">
                        <div class="popup-header">
                            <div class="header-info">
                                <h2 class="sensor-name">-</h2>
                                <span class="sensor-zone">-</span>
                            </div>
                            <div class="header-actions">
                                <span class="sensor-status" data-status="normal">Normal</span>
                                <button class="close-btn" type="button" aria-label="Close">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="popup-body">
                            <div class="current-values">
                                <div class="value-card">
                                    <div class="value-label">Temperature</div>
                                    <div class="value-number">
                                        <span class="sensor-temp">-</span>
                                        <span class="value-unit">&deg;C</span>
                                    </div>
                                </div>
                                <div class="value-card">
                                    <div class="value-label">Humidity</div>
                                    <div class="value-number">
                                        <span class="sensor-humidity">-</span>
                                        <span class="value-unit">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-section">
                                <div class="chart-header">
                                    <span class="chart-title">Temperature History</span>
                                </div>
                                <div class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        `;

        const cssCode = `
            .popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .popup-content {
                background: #1a1f2e;
                border-radius: 12px;
                width: 480px;
                max-width: 90vw;
                max-height: 90vh;
                overflow: hidden;
                box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
                border: 1px solid #2a3142;
            }

            .popup-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 24px;
                border-bottom: 1px solid #2a3142;
            }

            .header-info {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .sensor-name {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #e0e6ed;
            }

            .sensor-zone {
                font-size: 13px;
                color: #8892a0;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .sensor-status {
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
                text-transform: capitalize;
            }

            .sensor-status[data-status="normal"] {
                background: rgba(34, 197, 94, 0.15);
                color: #22c55e;
            }

            .sensor-status[data-status="warning"] {
                background: rgba(234, 179, 8, 0.15);
                color: #eab308;
            }

            .sensor-status[data-status="critical"] {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                padding: 0;
                background: transparent;
                border: none;
                border-radius: 6px;
                color: #8892a0;
                cursor: pointer;
                transition: background 0.15s, color 0.15s;
            }

            .close-btn:hover {
                background: #2a3142;
                color: #e0e6ed;
            }

            .popup-body {
                padding: 24px;
                display: flex;
                flex-direction: column;
                gap: 24px;
            }

            .current-values {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            .value-card {
                background: #252b3b;
                border-radius: 8px;
                padding: 16px;
            }

            .value-label {
                font-size: 12px;
                color: #8892a0;
                margin-bottom: 8px;
            }

            .value-number {
                display: flex;
                align-items: baseline;
                gap: 4px;
            }

            .sensor-temp,
            .sensor-humidity {
                font-size: 32px;
                font-weight: 600;
                color: #e0e6ed;
            }

            .value-unit {
                font-size: 16px;
                color: #8892a0;
            }

            .chart-section {
                background: #252b3b;
                border-radius: 8px;
                overflow: hidden;
            }

            .chart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 1px solid #2a3142;
            }

            .chart-title {
                font-size: 14px;
                font-weight: 500;
                color: #e0e6ed;
            }

            .chart-container {
                width: 100%;
                height: 200px;
            }
        `;

        // ======================
        // COMPONENT INSTANCE
        // ======================
        let instance = null;

        // ======================
        // register.js와 동일한 구조
        // ======================
        const { bind3DEvents, fetchData } = WKit;
        const { applyShadowPopupMixin, applyEChartsMixin } = PopupMixin;

        function extractTemplate(htmlCode, templateId) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlCode, 'text/html');
            const template = doc.querySelector(`template#${templateId}`);
            return template?.innerHTML || '';
        }

        function initComponent() {
            // ======================
            // 1. 데이터 정의
            // ======================
            const assetId = this.setter.ipsilonAssetInfo.assetId;

            this.datasetInfo = [
                { datasetName: 'sensor', param: { id: assetId }, render: ['renderSensorInfo'] },
                { datasetName: 'sensorHistory', param: { id: assetId }, render: ['renderChart'] }
            ];

            // ======================
            // 2. Data Config (API 필드 매핑)
            // ======================
            this.baseInfoConfig = [
                { key: 'name', selector: '.sensor-name' },
                { key: 'zone', selector: '.sensor-zone' },
                { key: 'status', selector: '.sensor-status', dataAttr: 'status' }
            ];

            this.sensorInfoConfig = [
                { key: 'temperature', selector: '.sensor-temp' },
                { key: 'humidity', selector: '.sensor-humidity' }
            ];

            this.chartConfig = {
                xKey: 'timestamps',
                series: [
                    { yKey: 'temperatures', color: '#3b82f6', smooth: true, areaStyle: true }
                ],
                optionBuilder: getLineChartOption
            };

            // ======================
            // 3. 렌더링 함수 바인딩
            // ======================
            this.renderSensorInfo = renderSensorInfo.bind(this, [...this.baseInfoConfig, ...this.sensorInfoConfig]);
            this.renderChart = renderChart.bind(this, this.chartConfig);

            // ======================
            // 4. Public Methods
            // ======================
            this.showDetail = showDetail.bind(this);
            this.hideDetail = hideDetail.bind(this);

            // ======================
            // 5. 이벤트 발행
            // ======================
            this.customEvents = {
                click: '@sensorClicked'
            };

            bind3DEvents(this, this.customEvents);

            // ======================
            // 6. Template Config
            // ======================
            this.templateConfig = {
                popup: 'popup-sensor',
            };

            // ======================
            // 7. Popup (template 기반)
            // ======================
            this.popupCreatedConfig = {
                chartSelector: '.chart-container',
                events: {
                    click: {
                        '.close-btn': () => this.hideDetail()
                    }
                }
            };

            const { htmlCode, cssCode } = this.properties.publishCode || {};
            this.getPopupHTML = () => extractTemplate(htmlCode || '', this.templateConfig.popup);
            this.getPopupStyles = () => cssCode || '';
            this.onPopupCreated = onPopupCreated.bind(this, this.popupCreatedConfig);

            applyShadowPopupMixin(this, {
                getHTML: this.getPopupHTML,
                getStyles: this.getPopupStyles,
                onCreated: this.onPopupCreated
            });

            applyEChartsMixin(this);

            console.log('[TemperatureSensor] Registered:', assetId);
        }

        // ======================
        // PUBLIC METHODS
        // ======================

        function showDetail() {
            this.showPopup();
            fx.go(
                this.datasetInfo,
                fx.each(({ datasetName, param, render }) =>
                    fx.go(
                        fetchData(this.page, datasetName, param),
                        result => result?.response?.data,
                        data => data && render.forEach(fn => this[fn](data))
                    )
                )
            ).catch(e => {
                console.error('[TemperatureSensor]', e);
                this.hidePopup();
            });
        }

        function renderSensorInfo(config, data) {
            fx.go(
                config,
                fx.each(({ key, selector, dataAttr }) => {
                    const el = this.popupQuery(selector);
                    el.textContent = data[key];
                    dataAttr && (el.dataset[dataAttr] = data[key]);
                })
            );
        }

        function renderChart(config, data) {
            const { optionBuilder, ...chartConfig } = config;
            const option = optionBuilder(chartConfig, data);
            this.updateChart('.chart-container', option);
        }

        function hideDetail() {
            this.hidePopup();
        }

        // ======================
        // CHART OPTION BUILDER
        // ======================

        function getLineChartOption(config, data) {
            const { xKey, series: seriesConfig } = config;

            return {
                grid: {
                    left: 40,
                    right: 16,
                    top: 16,
                    bottom: 24
                },
                xAxis: {
                    type: 'category',
                    data: data[xKey],
                    axisLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisLabel: { color: '#888', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: seriesConfig.map(({ yKey, color, smooth, areaStyle }) => ({
                    type: 'line',
                    data: data[yKey],
                    smooth: smooth,
                    symbol: 'none',
                    lineStyle: { color: color, width: 2 },
                    areaStyle: areaStyle ? {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: hexToRgba(color, 0.3) },
                                { offset: 1, color: hexToRgba(color, 0) }
                            ]
                        }
                    } : null
                }))
            };
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ======================
        // POPUP LIFECYCLE
        // ======================

        function onPopupCreated({chartSelector, events}) {
            chartSelector && this.createChart(chartSelector);
            events && this.bindPopupEvents(events);
        }

        // ======================
        // destroy.js와 동일한 구조
        // ======================

        function onInstanceUnLoad() {
            this.destroyPopup();
            console.log('[TemperatureSensor] Destroyed:', this.id);
        }

        // ======================
        // PREVIEW CONTROLS
        // ======================

        function createInstance() {
            if (instance) {
                onInstanceUnLoad.call(instance);
            }

            instance = {
                id: 'preview-sensor',
                page: { element: document.getElementById('popup-host') },
                properties: { publishCode: { htmlCode, cssCode } },
                setter: { ipsilonAssetInfo: { assetId: 'mock-001' } }
            };

            initComponent.call(instance);
        }

        function showSensor(status) {
            currentStatus = status;

            if (!instance) {
                createInstance();
            }

            instance.showDetail();
        }

        function destroyComponent() {
            if (instance) {
                onInstanceUnLoad.call(instance);
                instance = null;
                console.log('[Preview] Component destroyed');
            }
        }

        // 페이지 로드 시 인스턴스 생성
        createInstance();
    </script>
</body>
</html>
