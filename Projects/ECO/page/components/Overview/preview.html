<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview Component Preview - ECO Dashboard</title>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <!-- Tabulator CDN -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1219;
        }

        /* Container: Figma ÏÑ†ÌÉù ÏöîÏÜå ÌÅ¨Í∏∞ */
        #component-container {
            width: 800px;
            height: 100vh;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
    <link rel="stylesheet" href="styles/component.css">
</head>
<body>
    <!-- Component Container -->
    <div id="component-container">
        <!-- Overview Component (views/component.html) -->
        <div class="overview-panel">
            <div class="panel-header">
                <h2 class="panel-title">ECO Overview</h2>
                <button class="refresh-btn" title="Refresh">‚Üª</button>
            </div>

            <div class="panel-body">
                <!-- ÏÉÅÌÉú ÏöîÏïΩ ÏÑπÏÖò -->
                <div class="section summary-section">
                    <h3 class="section-title">Asset Status</h3>
                    <div class="summary-grid">
                        <div class="summary-card total">
                            <span class="summary-label">Ï†ÑÏ≤¥</span>
                            <span class="summary-value total-count">0</span>
                        </div>
                        <div class="summary-card normal">
                            <span class="summary-label">Ï†ïÏÉÅ</span>
                            <span class="summary-value normal-count">0</span>
                        </div>
                        <div class="summary-card warning">
                            <span class="summary-label">Í≤ΩÍ≥†</span>
                            <span class="summary-value warning-count">0</span>
                        </div>
                        <div class="summary-card critical">
                            <span class="summary-label">ÏúÑÌóò</span>
                            <span class="summary-value critical-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- ÏûêÏÇ∞ ÌÉÄÏûÖÎ≥Ñ ÌòÑÌô© & ÎèÑÎÑõ Ï∞®Ìä∏ -->
                <div class="section assets-section">
                    <div class="assets-by-type">
                        <h3 class="section-title">Assets by Type</h3>
                        <div class="type-grid">
                            <div class="type-card asset-ups">
                                <span class="type-icon">‚ö°</span>
                                <span class="type-label">UPS</span>
                                <div class="type-stats">
                                    <span class="type-total">0</span>
                                    <span class="type-detail">
                                        <span class="type-normal">0</span> /
                                        <span class="type-warning">0</span> /
                                        <span class="type-critical">0</span>
                                    </span>
                                </div>
                            </div>
                            <div class="type-card asset-pdu">
                                <span class="type-icon">üîå</span>
                                <span class="type-label">PDU</span>
                                <div class="type-stats">
                                    <span class="type-total">0</span>
                                    <span class="type-detail">
                                        <span class="type-normal">0</span> /
                                        <span class="type-warning">0</span> /
                                        <span class="type-critical">0</span>
                                    </span>
                                </div>
                            </div>
                            <div class="type-card asset-crac">
                                <span class="type-icon">‚ùÑÔ∏è</span>
                                <span class="type-label">CRAC</span>
                                <div class="type-stats">
                                    <span class="type-total">0</span>
                                    <span class="type-detail">
                                        <span class="type-normal">0</span> /
                                        <span class="type-warning">0</span> /
                                        <span class="type-critical">0</span>
                                    </span>
                                </div>
                            </div>
                            <div class="type-card asset-sensor">
                                <span class="type-icon">üå°Ô∏è</span>
                                <span class="type-label">Sensor</span>
                                <div class="type-stats">
                                    <span class="type-total">0</span>
                                    <span class="type-detail">
                                        <span class="type-normal">0</span> /
                                        <span class="type-warning">0</span> /
                                        <span class="type-critical">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="status-chart-container">
                        <div class="status-chart"></div>
                    </div>
                </div>

                <!-- KPI ÏÑπÏÖò -->
                <div class="section kpi-section">
                    <h3 class="section-title">Key Performance Indicators</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <span class="kpi-label">Ï¥ù Ï†ÑÎ†•</span>
                            <span class="kpi-value kpi-power">-</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">ÌèâÍ∑† Î∂ÄÌïòÏú®</span>
                            <span class="kpi-value kpi-load">-</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">PUE</span>
                            <span class="kpi-value kpi-pue">-</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">ÌèâÍ∑† Ïò®ÎèÑ</span>
                            <span class="kpi-value kpi-temp">-</span>
                        </div>
                        <div class="kpi-card">
                            <span class="kpi-label">ÌèâÍ∑† ÏäµÎèÑ</span>
                            <span class="kpi-value kpi-humidity">-</span>
                        </div>
                    </div>
                </div>

                <!-- ÏµúÍ∑º Ïù¥Î≤§Ìä∏ ÏÑπÏÖò -->
                <div class="section events-section">
                    <h3 class="section-title">Recent Events</h3>
                    <div class="event-table"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock Data -->
    <script>
        const MOCK_DATA = {
            overview: {
                summary: { total: 24, normal: 20, warning: 3, critical: 1 },
                assetsByType: {
                    ups: { total: 4, normal: 3, warning: 1, critical: 0 },
                    pdu: { total: 8, normal: 6, warning: 1, critical: 1 },
                    crac: { total: 4, normal: 4, warning: 0, critical: 0 },
                    sensor: { total: 8, normal: 7, warning: 1, critical: 0 }
                },
                kpi: { totalPower: 142.5, avgLoad: 67.3, pue: 1.52, avgTemp: 24.8, avgHumidity: 52.1 }
            },
            overviewEvents: {
                events: [
                    { id: 'evt-1', time: '14:30', asset: 'ups-002', type: 'UPS', severity: 'warning', message: 'Battery level below threshold' },
                    { id: 'evt-2', time: '14:15', asset: 'pdu-003', type: 'PDU', severity: 'critical', message: 'Power consumption spike' },
                    { id: 'evt-3', time: '14:00', asset: 'sensor-004', type: 'Sensor', severity: 'warning', message: 'High temperature detected' },
                    { id: 'evt-4', time: '13:45', asset: 'crac-001', type: 'CRAC', severity: 'info', message: 'Cooling system optimized' },
                    { id: 'evt-5', time: '13:30', asset: 'ups-001', type: 'UPS', severity: 'info', message: 'Connection restored' }
                ]
            }
        };
    </script>

    <!-- Render Functions (from scripts/register.js) -->
    <script>
        const container = document.getElementById('component-container');

        // ======================
        // DATA CONFIG
        // ======================

        const summaryConfig = {
            total: { selector: '.total-count' },
            normal: { selector: '.normal-count' },
            warning: { selector: '.warning-count' },
            critical: { selector: '.critical-count' }
        };

        const kpiConfig = [
            { key: 'totalPower', selector: '.kpi-power', suffix: 'kW' },
            { key: 'avgLoad', selector: '.kpi-load', suffix: '%' },
            { key: 'pue', selector: '.kpi-pue', suffix: '' },
            { key: 'avgTemp', selector: '.kpi-temp', suffix: '¬∞C' },
            { key: 'avgHumidity', selector: '.kpi-humidity', suffix: '%' }
        ];

        const assetTypeConfig = [
            { key: 'ups', selector: '.asset-ups' },
            { key: 'pdu', selector: '.asset-pdu' },
            { key: 'crac', selector: '.asset-crac' },
            { key: 'sensor', selector: '.asset-sensor' }
        ];

        // ======================
        // ECHARTS INITIALIZATION
        // ======================

        const chartContainer = container.querySelector('.status-chart');
        let chartInstance = null;

        if (chartContainer) {
            chartInstance = echarts.init(chartContainer);

            // Handle resize with ResizeObserver
            const resizeObserver = new ResizeObserver(() => {
                chartInstance && chartInstance.resize();
            });
            resizeObserver.observe(chartContainer);
        }

        // ======================
        // TABULATOR INITIALIZATION
        // ======================

        const tableContainer = container.querySelector('.event-table');
        let tableInstance = null;

        if (tableContainer) {
            tableContainer.id = 'overview-event-table';

            tableInstance = new Tabulator('#overview-event-table', {
                layout: 'fitColumns',
                height: 200,
                placeholder: 'No events',
                columns: [
                    { title: 'Time', field: 'time', widthGrow: 1.5 },
                    { title: 'Asset', field: 'asset', widthGrow: 1 },
                    { title: 'Type', field: 'type', widthGrow: 0.8 },
                    {
                        title: 'Severity',
                        field: 'severity',
                        widthGrow: 0.8,
                        formatter: function(cell) {
                            const value = cell.getValue();
                            const colors = { critical: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
                            return `<span style="color: ${colors[value] || '#888'}">${value.toUpperCase()}</span>`;
                        }
                    },
                    { title: 'Message', field: 'message', widthGrow: 3 }
                ]
            });
        }

        // ======================
        // RENDER FUNCTIONS
        // ======================

        function renderOverview(response) {
            const { summary, assetsByType, kpi } = response;
            console.log('[Overview] renderOverview');

            // ÏûêÏÇ∞ ÏÉÅÌÉú ÏöîÏïΩ
            if (summary) {
                Object.entries(summaryConfig).forEach(([key, config]) => {
                    const el = container.querySelector(config.selector);
                    if (el) el.textContent = summary[key] || 0;
                });
            }

            // ÌÉÄÏûÖÎ≥Ñ ÏûêÏÇ∞ ÌòÑÌô©
            if (assetsByType) {
                assetTypeConfig.forEach(({ key, selector }) => {
                    const el = container.querySelector(selector);
                    if (el && assetsByType[key]) {
                        const typeData = assetsByType[key];
                        const totalEl = el.querySelector('.type-total');
                        const normalEl = el.querySelector('.type-normal');
                        const warningEl = el.querySelector('.type-warning');
                        const criticalEl = el.querySelector('.type-critical');

                        if (totalEl) totalEl.textContent = typeData.total;
                        if (normalEl) normalEl.textContent = typeData.normal;
                        if (warningEl) warningEl.textContent = typeData.warning;
                        if (criticalEl) criticalEl.textContent = typeData.critical;
                    }
                });
            }

            // KPI Î†åÎçîÎßÅ
            if (kpi) {
                kpiConfig.forEach(({ key, selector, suffix }) => {
                    const el = container.querySelector(selector);
                    if (el) el.textContent = `${kpi[key]}${suffix}`;
                });
            }

            // ÏÉÅÌÉú ÎèÑÎÑõ Ï∞®Ìä∏
            if (summary && chartInstance) {
                renderStatusChart(summary);
            }
        }

        function renderStatusChart(summary) {
            const option = {
                tooltip: { trigger: 'item' },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#8892a0', fontSize: 11 }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    center: ['35%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 4, borderColor: '#1a1f2e', borderWidth: 2 },
                    label: { show: false },
                    data: [
                        { value: summary.normal, name: 'Ï†ïÏÉÅ', itemStyle: { color: '#22c55e' } },
                        { value: summary.warning, name: 'Í≤ΩÍ≥†', itemStyle: { color: '#f59e0b' } },
                        { value: summary.critical, name: 'ÏúÑÌóò', itemStyle: { color: '#ef4444' } }
                    ]
                }]
            };

            try {
                chartInstance.setOption(option);
            } catch (error) {
                console.error('[Overview] ECharts setOption error:', error);
            }
        }

        function renderEventTable(response) {
            const { events } = response;
            console.log(`[Overview] renderEventTable: ${events?.length || 0} events`);

            if (!events || !tableInstance) return;

            tableInstance.setData(events);
        }

        // ======================
        // EVENT BINDING
        // ======================

        container.querySelector('.refresh-btn').addEventListener('click', () => {
            console.log('[Overview] Refresh clicked');
            renderOverview(MOCK_DATA.overview);
            renderEventTable(MOCK_DATA.overviewEvents);
        });

        // ======================
        // INITIAL RENDER
        // ======================

        // Wait for Tabulator to be ready
        if (tableInstance) {
            tableInstance.on('tableBuilt', () => {
                renderOverview(MOCK_DATA.overview);
                renderEventTable(MOCK_DATA.overviewEvents);
            });
        } else {
            renderOverview(MOCK_DATA.overview);
        }
    </script>
</body>
</html>
