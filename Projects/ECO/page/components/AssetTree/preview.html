<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetTree Component Preview - ECO Dashboard</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1219;
        }

        /* Container: Figma ÏÑ†ÌÉù ÏöîÏÜå ÌÅ¨Í∏∞ */
        #component-container {
            width: 360px;
            height: 600px;
            margin: 20px auto;
        }

        .event-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: #252b3d;
            border-radius: 8px;
            border: 1px solid #2a3142;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .event-log h3 { font-size: 12px; color: #8892a0; margin-bottom: 8px; }
        .event-log-item { font-size: 11px; color: #3b82f6; padding: 4px 0; border-bottom: 1px solid #2a3142; }
    </style>
    <link rel="stylesheet" href="styles/component.css">
</head>
<body>
    <!-- Component Container -->
    <div id="component-container">
        <!-- AssetTree Component (views/component.html) -->
        <div class="asset-tree-panel">
            <div class="panel-header">
                <h2 class="panel-title">Asset Navigator</h2>
                <button class="refresh-btn" title="Refresh">‚Üª</button>
            </div>

            <div class="toolbar">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search assets...">
                </div>
                <div class="filter-box">
                    <select class="status-filter">
                        <option value="all">All Status</option>
                        <option value="normal">Normal</option>
                        <option value="warning">Warning</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="tree-actions">
                    <button class="expand-all-btn" title="Expand All">‚äû</button>
                    <button class="collapse-all-btn" title="Collapse All">‚äü</button>
                </div>
            </div>

            <div class="panel-body">
                <div class="tree-container">
                    <!-- Tree will be rendered here -->
                </div>
            </div>

            <div class="panel-footer">
                <div class="legend">
                    <span class="legend-item"><span class="dot normal"></span> Normal</span>
                    <span class="legend-item"><span class="dot warning"></span> Warning</span>
                    <span class="legend-item"><span class="dot critical"></span> Critical</span>
                </div>
            </div>
        </div>
    </div>

    <div class="event-log" id="eventLog">
        <h3>Event Log</h3>
    </div>

    <!-- Mock Data -->
    <script>
        const MOCK_DATA = {
            assetTree: {
                zones: [
                    {
                        id: 'zone-a',
                        name: 'Zone A - Main Hall',
                        totalAssets: 12,
                        assets: {
                            ups: [
                                { id: 'ups-001', name: 'UPS Main-A', status: 'normal' },
                                { id: 'ups-002', name: 'UPS Main-B', status: 'warning' }
                            ],
                            pdu: [
                                { id: 'pdu-001', name: 'PDU Rack-01', status: 'normal' },
                                { id: 'pdu-002', name: 'PDU Rack-02', status: 'normal' },
                                { id: 'pdu-003', name: 'PDU Rack-03', status: 'critical' }
                            ],
                            crac: [
                                { id: 'crac-001', name: 'CRAC Unit-A1', status: 'normal' },
                                { id: 'crac-002', name: 'CRAC Unit-A2', status: 'normal' }
                            ],
                            sensor: [
                                { id: 'sensor-001', name: 'Temp Sensor Row-1', status: 'normal' },
                                { id: 'sensor-002', name: 'Temp Sensor Row-2', status: 'normal' },
                                { id: 'sensor-003', name: 'Temp Sensor Row-3', status: 'warning' },
                                { id: 'sensor-004', name: 'Humidity Sensor', status: 'normal' }
                            ]
                        }
                    },
                    {
                        id: 'zone-b',
                        name: 'Zone B - Power Room',
                        totalAssets: 8,
                        assets: {
                            ups: [
                                { id: 'ups-003', name: 'UPS Backup-A', status: 'normal' },
                                { id: 'ups-004', name: 'UPS Backup-B', status: 'normal' }
                            ],
                            pdu: [
                                { id: 'pdu-004', name: 'PDU Power-01', status: 'normal' },
                                { id: 'pdu-005', name: 'PDU Power-02', status: 'warning' }
                            ],
                            crac: [
                                { id: 'crac-003', name: 'CRAC Unit-B1', status: 'normal' }
                            ],
                            sensor: [
                                { id: 'sensor-005', name: 'Temp Sensor B-1', status: 'normal' },
                                { id: 'sensor-006', name: 'Temp Sensor B-2', status: 'normal' },
                                { id: 'sensor-007', name: 'Power Sensor', status: 'normal' }
                            ]
                        }
                    }
                ]
            }
        };
    </script>

    <!-- Render Functions (from scripts/register.js) -->
    <script>
        const container = document.getElementById('component-container');

        // ======================
        // STATE
        // ======================

        let _treeData = null;
        let _expandedNodes = new Set(['root']);
        let _searchTerm = '';
        let _filterStatus = 'all';

        // ======================
        // ICON CONFIG
        // ======================

        const typeIcons = {
            ups: '‚ö°',
            pdu: 'üîå',
            crac: '‚ùÑÔ∏è',
            sensor: 'üå°Ô∏è'
        };

        const statusColors = {
            normal: '#22c55e',
            warning: '#f59e0b',
            critical: '#ef4444'
        };

        // ======================
        // RENDER FUNCTIONS
        // ======================

        function renderTree(response) {
            const { zones } = response;
            console.log(`[AssetTree] renderTree: ${zones?.length || 0} zones`);

            _treeData = response;
            updateTreeView();
        }

        function updateTreeView() {
            const treeContainer = container.querySelector('.tree-container');
            if (!treeContainer || !_treeData) return;

            const html = buildTreeHTML(_treeData.zones);
            treeContainer.innerHTML = html;
            bindTreeEvents(treeContainer);
        }

        function buildTreeHTML(zones) {
            const searchTerm = _searchTerm.toLowerCase();
            const filterStatus = _filterStatus;

            let html = '<ul class="tree-root">';

            zones.forEach(zone => {
                const zoneId = `zone-${zone.id}`;
                const isExpanded = _expandedNodes.has(zoneId);

                // ÌïÑÌÑ∞ÎßÅÎêú ÏûêÏÇ∞ ÏàòÏßë
                const filteredTypes = {};
                let zoneHasMatch = false;

                Object.entries(zone.assets).forEach(([type, assets]) => {
                    const filtered = assets.filter(asset => {
                        const matchesSearch = !searchTerm ||
                            asset.name.toLowerCase().includes(searchTerm) ||
                            asset.id.toLowerCase().includes(searchTerm);
                        const matchesStatus = filterStatus === 'all' || asset.status === filterStatus;
                        return matchesSearch && matchesStatus;
                    });

                    if (filtered.length > 0) {
                        filteredTypes[type] = filtered;
                        zoneHasMatch = true;
                    }
                });

                if (!zoneHasMatch && searchTerm) return;

                html += `
                    <li class="tree-node zone-node ${isExpanded ? 'expanded' : ''}">
                        <div class="node-header" data-node-id="${zoneId}">
                            <span class="node-toggle">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            <span class="node-icon">üìÅ</span>
                            <span class="node-label">${zone.name}</span>
                            <span class="node-count">${zone.totalAssets}</span>
                        </div>
                        <ul class="node-children" style="display: ${isExpanded ? 'block' : 'none'}">
                `;

                Object.entries(filteredTypes).forEach(([type, assets]) => {
                    const typeId = `${zoneId}-${type}`;
                    const isTypeExpanded = _expandedNodes.has(typeId);
                    const typeIcon = typeIcons[type] || 'üì¶';

                    html += `
                        <li class="tree-node type-node ${isTypeExpanded ? 'expanded' : ''}">
                            <div class="node-header" data-node-id="${typeId}">
                                <span class="node-toggle">${isTypeExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                <span class="node-icon">${typeIcon}</span>
                                <span class="node-label">${type.toUpperCase()}</span>
                                <span class="node-count">${assets.length}</span>
                            </div>
                            <ul class="node-children" style="display: ${isTypeExpanded ? 'block' : 'none'}">
                    `;

                    assets.forEach(asset => {
                        const statusColor = statusColors[asset.status] || '#888';
                        html += `
                            <li class="tree-node asset-node" data-asset-id="${asset.id}" data-asset-type="${type}">
                                <div class="node-header asset-header">
                                    <span class="status-dot" style="background: ${statusColor}"></span>
                                    <span class="node-label">${asset.name}</span>
                                    <span class="asset-id">${asset.id}</span>
                                </div>
                            </li>
                        `;
                    });

                    html += '</ul></li>';
                });

                html += '</ul></li>';
            });

            html += '</ul>';
            return html;
        }

        function bindTreeEvents(treeContainer) {
            // ÌÜ†Í∏Ä ÌÅ¥Î¶≠
            treeContainer.querySelectorAll('.node-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const header = e.target.closest('.node-header');
                    const nodeId = header.dataset.nodeId;
                    if (nodeId) {
                        toggleNode(nodeId);
                    }
                });
            });

            // ÏûêÏÇ∞ ÌÅ¥Î¶≠
            treeContainer.querySelectorAll('.asset-node').forEach(node => {
                node.addEventListener('click', () => {
                    const assetId = node.dataset.assetId;
                    const assetType = node.dataset.assetType;
                    onAssetClick(assetId, assetType);
                });
            });
        }

        function toggleNode(nodeId) {
            if (_expandedNodes.has(nodeId)) {
                _expandedNodes.delete(nodeId);
            } else {
                _expandedNodes.add(nodeId);
            }
            updateTreeView();
        }

        function onAssetClick(assetId, assetType) {
            logEvent(`Asset clicked: ${assetId} (${assetType})`);

            // ÏÑ†ÌÉù ÏÉÅÌÉú ÌëúÏãú
            const prevSelected = container.querySelector('.asset-node.selected');
            if (prevSelected) prevSelected.classList.remove('selected');

            const currentNode = container.querySelector(`[data-asset-id="${assetId}"]`);
            if (currentNode) currentNode.classList.add('selected');
        }

        // ======================
        // SEARCH & FILTER
        // ======================

        function onSearch(term) {
            _searchTerm = term;
            updateTreeView();
        }

        function onFilterChange(status) {
            _filterStatus = status;
            updateTreeView();
        }

        function expandAll() {
            if (!_treeData) return;
            _treeData.zones.forEach(zone => {
                _expandedNodes.add(`zone-${zone.id}`);
                Object.keys(zone.assets).forEach(type => {
                    _expandedNodes.add(`zone-${zone.id}-${type}`);
                });
            });
            updateTreeView();
        }

        function collapseAll() {
            _expandedNodes.clear();
            _expandedNodes.add('root');
            updateTreeView();
        }

        // ======================
        // EVENT LOG
        // ======================

        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const item = document.createElement('div');
            item.className = 'event-log-item';
            item.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
        }

        // ======================
        // EVENT BINDING
        // ======================

        container.querySelector('.refresh-btn').addEventListener('click', () => {
            logEvent('Refresh clicked');
            renderTree(MOCK_DATA.assetTree);
        });

        container.querySelector('.search-input').addEventListener('input', (e) => {
            onSearch(e.target.value);
        });

        container.querySelector('.status-filter').addEventListener('change', (e) => {
            onFilterChange(e.target.value);
        });

        container.querySelector('.expand-all-btn').addEventListener('click', () => {
            logEvent('Expand All clicked');
            expandAll();
        });

        container.querySelector('.collapse-all-btn').addEventListener('click', () => {
            logEvent('Collapse All clicked');
            collapseAll();
        });

        // ======================
        // INITIAL RENDER
        // ======================

        renderTree(MOCK_DATA.assetTree);
    </script>
</body>
</html>
