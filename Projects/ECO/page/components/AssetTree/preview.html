<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetTree Component Preview - ECO Dashboard</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1219;
        }

        /* Container: Figma ÏÑ†ÌÉù ÏöîÏÜå ÌÅ¨Í∏∞ */
        #component-container {
            width: 360px;
            height: 600px;
            margin: 20px auto;
        }

        .event-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: #252b3d;
            border-radius: 8px;
            border: 1px solid #2a3142;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .event-log h3 { font-size: 12px; color: #8892a0; margin-bottom: 8px; }
        .event-log-item { font-size: 11px; color: #3b82f6; padding: 4px 0; border-bottom: 1px solid #2a3142; }
    </style>
    <link rel="stylesheet" href="styles/component.css">
</head>
<body>
    <!-- Component Container -->
    <div id="component-container">
        <!-- AssetTree Component (views/component.html) -->
        <div class="asset-tree-panel">
            <div class="panel-header">
                <h2 class="panel-title">Asset Navigator</h2>
                <button class="refresh-btn" title="Refresh">‚Üª</button>
            </div>

            <div class="toolbar">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search assets...">
                </div>
                <div class="filter-box">
                    <select class="status-filter">
                        <option value="all">All Status</option>
                        <option value="normal">Normal</option>
                        <option value="warning">Warning</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="tree-actions">
                    <button class="expand-all-btn" title="Expand All">‚äû</button>
                    <button class="collapse-all-btn" title="Collapse All">‚äü</button>
                </div>
            </div>

            <div class="panel-body">
                <div class="tree-container">
                    <ul class="tree-root"></ul>
                </div>
            </div>

            <div class="panel-footer">
                <div class="legend">
                    <span class="legend-item"><span class="dot normal"></span> Normal</span>
                    <span class="legend-item"><span class="dot warning"></span> Warning</span>
                    <span class="legend-item"><span class="dot critical"></span> Critical</span>
                </div>
            </div>
        </div>

        <!-- Tree Node Templates -->
        <template id="tpl-zone-node">
            <li class="tree-node zone-node">
                <div class="node-header" data-node-id="">
                    <span class="node-toggle">‚ñ∂</span>
                    <span class="node-icon">üìÅ</span>
                    <span class="node-label"></span>
                    <span class="node-count"></span>
                </div>
                <ul class="node-children"></ul>
            </li>
        </template>

        <template id="tpl-type-node">
            <li class="tree-node type-node">
                <div class="node-header" data-node-id="">
                    <span class="node-toggle">‚ñ∂</span>
                    <span class="node-icon"></span>
                    <span class="node-label"></span>
                    <span class="node-count"></span>
                </div>
                <ul class="node-children"></ul>
            </li>
        </template>

        <template id="tpl-asset-node">
            <li class="tree-node asset-node" data-asset-id="" data-asset-type="">
                <div class="node-header asset-header">
                    <span class="status-dot"></span>
                    <span class="node-label"></span>
                    <span class="asset-id"></span>
                </div>
            </li>
        </template>
    </div>

    <div class="event-log" id="eventLog">
        <h3>Event Log</h3>
    </div>

    <!-- Mock Data -->
    <script>
        const MOCK_DATA = {
            assetTree: {
                zones: [
                    {
                        id: 'zone-a',
                        name: 'Zone A - Main Hall',
                        totalAssets: 12,
                        assets: {
                            ups: [
                                { id: 'ups-001', name: 'UPS Main-A', status: 'normal' },
                                { id: 'ups-002', name: 'UPS Main-B', status: 'warning' }
                            ],
                            pdu: [
                                { id: 'pdu-001', name: 'PDU Rack-01', status: 'normal' },
                                { id: 'pdu-002', name: 'PDU Rack-02', status: 'normal' },
                                { id: 'pdu-003', name: 'PDU Rack-03', status: 'critical' }
                            ],
                            crac: [
                                { id: 'crac-001', name: 'CRAC Unit-A1', status: 'normal' },
                                { id: 'crac-002', name: 'CRAC Unit-A2', status: 'normal' }
                            ],
                            sensor: [
                                { id: 'sensor-001', name: 'Temp Sensor Row-1', status: 'normal' },
                                { id: 'sensor-002', name: 'Temp Sensor Row-2', status: 'normal' },
                                { id: 'sensor-003', name: 'Temp Sensor Row-3', status: 'warning' },
                                { id: 'sensor-004', name: 'Humidity Sensor', status: 'normal' }
                            ]
                        }
                    },
                    {
                        id: 'zone-b',
                        name: 'Zone B - Power Room',
                        totalAssets: 8,
                        assets: {
                            ups: [
                                { id: 'ups-003', name: 'UPS Backup-A', status: 'normal' },
                                { id: 'ups-004', name: 'UPS Backup-B', status: 'normal' }
                            ],
                            pdu: [
                                { id: 'pdu-004', name: 'PDU Power-01', status: 'normal' },
                                { id: 'pdu-005', name: 'PDU Power-02', status: 'warning' }
                            ],
                            crac: [
                                { id: 'crac-003', name: 'CRAC Unit-B1', status: 'normal' }
                            ],
                            sensor: [
                                { id: 'sensor-005', name: 'Temp Sensor B-1', status: 'normal' },
                                { id: 'sensor-006', name: 'Temp Sensor B-2', status: 'normal' },
                                { id: 'sensor-007', name: 'Power Sensor', status: 'normal' }
                            ]
                        }
                    }
                ]
            }
        };
    </script>

    <!-- Render Functions (from scripts/register.js) -->
    <script>
        const container = document.getElementById('component-container');

        // ======================
        // STATE
        // ======================

        let _treeData = null;
        let _expandedNodes = new Set(['root']);
        let _searchTerm = '';
        let _filterStatus = 'all';

        // ======================
        // CONFIG
        // ======================

        const typeIcons = { ups: '‚ö°', pdu: 'üîå', crac: '‚ùÑÔ∏è', sensor: 'üå°Ô∏è' };
        const statusColors = { normal: '#22c55e', warning: '#f59e0b', critical: '#ef4444' };

        // ======================
        // TEMPLATE REFERENCES
        // ======================

        const templates = {
            zone: container.querySelector('#tpl-zone-node'),
            type: container.querySelector('#tpl-type-node'),
            asset: container.querySelector('#tpl-asset-node')
        };

        // ======================
        // RENDER FUNCTIONS
        // ======================

        function renderTree(response) {
            console.log(`[AssetTree] renderTree: ${response.zones?.length || 0} zones`);
            _treeData = response;
            updateTreeView();
        }

        function updateTreeView() {
            const treeRoot = container.querySelector('.tree-root');
            if (!treeRoot || !_treeData) return;

            treeRoot.innerHTML = '';
            buildTree(treeRoot, _treeData.zones);
            bindTreeEvents(treeRoot);
        }

        function buildTree(treeRoot, zones) {
            const searchTerm = _searchTerm.toLowerCase();
            const filterStatus = _filterStatus;

            zones.forEach(zone => {
                const filteredTypes = {};
                let zoneHasMatch = false;

                Object.entries(zone.assets).forEach(([type, assets]) => {
                    const filtered = assets.filter(asset => {
                        const matchesSearch = !searchTerm ||
                            asset.name.toLowerCase().includes(searchTerm) ||
                            asset.id.toLowerCase().includes(searchTerm);
                        const matchesStatus = filterStatus === 'all' || asset.status === filterStatus;
                        return matchesSearch && matchesStatus;
                    });

                    if (filtered.length > 0) {
                        filteredTypes[type] = filtered;
                        zoneHasMatch = true;
                    }
                });

                if (!zoneHasMatch && searchTerm) return;

                const zoneNode = createZoneNode(zone);
                const zoneChildren = zoneNode.querySelector('.node-children');

                Object.entries(filteredTypes).forEach(([type, assets]) => {
                    const typeNode = createTypeNode(zone.id, type, assets.length);
                    const typeChildren = typeNode.querySelector('.node-children');

                    assets.forEach(asset => {
                        typeChildren.appendChild(createAssetNode(asset, type));
                    });

                    zoneChildren.appendChild(typeNode);
                });

                treeRoot.appendChild(zoneNode);
            });
        }

        function createZoneNode(zone) {
            const zoneId = `zone-${zone.id}`;
            const isExpanded = _expandedNodes.has(zoneId);

            const node = templates.zone.content.cloneNode(true).firstElementChild;
            node.classList.toggle('expanded', isExpanded);
            node.querySelector('.node-header').dataset.nodeId = zoneId;
            node.querySelector('.node-toggle').textContent = isExpanded ? '‚ñº' : '‚ñ∂';
            node.querySelector('.node-label').textContent = zone.name;
            node.querySelector('.node-count').textContent = zone.totalAssets;
            node.querySelector('.node-children').style.display = isExpanded ? 'block' : 'none';

            return node;
        }

        function createTypeNode(zoneId, type, count) {
            const typeId = `zone-${zoneId}-${type}`;
            const isExpanded = _expandedNodes.has(typeId);

            const node = templates.type.content.cloneNode(true).firstElementChild;
            node.classList.toggle('expanded', isExpanded);
            node.querySelector('.node-header').dataset.nodeId = typeId;
            node.querySelector('.node-toggle').textContent = isExpanded ? '‚ñº' : '‚ñ∂';
            node.querySelector('.node-icon').textContent = typeIcons[type] || 'üì¶';
            node.querySelector('.node-label').textContent = type.toUpperCase();
            node.querySelector('.node-count').textContent = count;
            node.querySelector('.node-children').style.display = isExpanded ? 'block' : 'none';

            return node;
        }

        function createAssetNode(asset, type) {
            const node = templates.asset.content.cloneNode(true).firstElementChild;
            node.dataset.assetId = asset.id;
            node.dataset.assetType = type;
            node.querySelector('.status-dot').style.background = statusColors[asset.status] || '#888';
            node.querySelector('.node-label').textContent = asset.name;
            node.querySelector('.asset-id').textContent = asset.id;

            return node;
        }

        function bindTreeEvents(treeRoot) {
            treeRoot.querySelectorAll('.node-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const nodeId = e.target.closest('.node-header').dataset.nodeId;
                    if (nodeId) toggleNode(nodeId);
                });
            });

            treeRoot.querySelectorAll('.asset-node').forEach(node => {
                node.addEventListener('click', () => {
                    onAssetClick(node.dataset.assetId, node.dataset.assetType);
                });
            });
        }

        function toggleNode(nodeId) {
            _expandedNodes.has(nodeId) ? _expandedNodes.delete(nodeId) : _expandedNodes.add(nodeId);
            updateTreeView();
        }

        function onAssetClick(assetId, assetType) {
            logEvent(`Asset clicked: ${assetId} (${assetType})`);

            container.querySelector('.asset-node.selected')?.classList.remove('selected');
            container.querySelector(`[data-asset-id="${assetId}"]`)?.classList.add('selected');
        }

        // ======================
        // SEARCH & FILTER
        // ======================

        function onSearch(term) { _searchTerm = term; updateTreeView(); }
        function onFilterChange(status) { _filterStatus = status; updateTreeView(); }

        function expandAll() {
            if (!_treeData) return;
            _treeData.zones.forEach(zone => {
                _expandedNodes.add(`zone-${zone.id}`);
                Object.keys(zone.assets).forEach(type => _expandedNodes.add(`zone-${zone.id}-${type}`));
            });
            updateTreeView();
        }

        function collapseAll() {
            _expandedNodes.clear();
            _expandedNodes.add('root');
            updateTreeView();
        }

        // ======================
        // EVENT LOG
        // ======================

        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const item = document.createElement('div');
            item.className = 'event-log-item';
            item.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
        }

        // ======================
        // EVENT BINDING
        // ======================

        container.querySelector('.refresh-btn').addEventListener('click', () => {
            logEvent('Refresh clicked');
            renderTree(MOCK_DATA.assetTree);
        });
        container.querySelector('.search-input').addEventListener('input', (e) => onSearch(e.target.value));
        container.querySelector('.status-filter').addEventListener('change', (e) => onFilterChange(e.target.value));
        container.querySelector('.expand-all-btn').addEventListener('click', () => { logEvent('Expand All'); expandAll(); });
        container.querySelector('.collapse-all-btn').addEventListener('click', () => { logEvent('Collapse All'); collapseAll(); });

        // ======================
        // INITIAL RENDER
        // ======================

        renderTree(MOCK_DATA.assetTree);
    </script>
</body>
</html>
