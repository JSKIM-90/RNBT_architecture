# Codex Pattern Analysis

## 개요
- 런타임 HTML/CSS/JS 생성 + 템플릿(`template` 태그) + 토픽 기반 데이터 퍼블리셔/구독(pub-sub) 조합.
- 번들 없이 전역 스코프에서 동작하며, FP 헬퍼(fx.js)와 유틸(WKit, GlobalDataPublisher, WEventbus)이 핵심 인프라.

## 장점
- 가벼운 의존성: 프레임워크 없이 표준 브라우저 API와 소형 유틸로 구성 → 초기 진입/적용이 쉬움.
- 토픽 중심 데이터 팬아웃: GlobalDataPublisher가 fetch → 캐시/팬아웃을 맡아 위젯 다수가 동일 토픽을 구독해도 네트워크 중복을 최소화할 수 있음.
- 느슨한 결합: pub-sub + FP 헬퍼로 위젯 간 직접 의존을 줄여 레이아웃 변경이나 기능 추가가 유연함.
- 2D/3D 이벤트 바인딩 분리: WKit이 DOM delegate와 Three.js Raycasting을 분리 관리해 입체/평면 위젯 동시 지원 용이.

## 주요 리스크
- 전역 스코프 충돌: 번들이 없고 네임스페이스가 약해 이벤트 이름, 전역 객체 충돌 위험. 이벤트 일괄 해제/네임스페이스 지원 부족.
- 라이프사이클 누수 가능성: before_load/loaded/before_unload 가이드가 있으나 구독·인터벌·3D 리소스의 강제 해제 장치가 없음.
- 데이터 최신성: fetch 응답 역전(느린 응답이 최신을 덮는 현상) 방지 가드, 토픽별 in-flight 합치기/캐시 부재.
- 렌더 성능: 문자열 DOM 조립 위주라 대량 업데이트 시 비용/누수 우려. 부분 렌더/최소 교체 헬퍼가 필요.
- 스키마 계약 부재: 토픽 페이로드 형태가 변해도 핸들러 서명 깨짐을 조기 탐지하기 어려움.

## 개선 제안 (번들 없이 적용 가능)
1) 이벤트/구독 스코프: 이벤트 이름 접두어(`@iot:` 등) 강제, 페이지 단위 offAll(namespace) 추가. `bindEvents`의 `preventDefault`는 옵션화.
2) Disposable 레지스트리: 구독, 인터벌, 3D 리소스, 임시 DOM을 등록/해제하는 공통 래퍼를 두고 before_unload에서 일괄 정리.
3) 데이터 가드: GlobalDataPublisher.fetchAndPublish에 토픽별 in-flight 합치기, 타임스탬프/버전 가드(오래된 응답 무시), 동일 instance·handler 중복 등록 방지.
4) 템플릿 렌더 헬퍼: `template` 클론 → 데이터 바인딩 → key 기반 최소 교체 패턴을 공통 함수로 추출해 포커스/상태 보존 및 누수 최소화.
5) 스키마/문서화: 토픽별 페이로드를 zod/io-ts CDN 빌드 등으로 런타임 검증 + 타입 정의로 문서화. 실패 시 로그 + UI 훅 제공.
6) 네임스페이스 자원: JS 전역, CSS 클래스, dataset 키에 접두어 부여. 스크립트 로드 순서를 명시 관리.

## 결론
현 패턴은 작은 PoC나 빠른 제작에는 적합하나, SI 규모 대시보드에서는 네임스페이스, 라이프사이클 정리, 데이터 최신성, 부분 렌더, 스키마 계약을 보강해야 유지보수/안정성을 확보할 수 있음. 위의 최소 보강으로도 번들 없이 패턴을 생산 환경에 더 안전하게 적용 가능.
