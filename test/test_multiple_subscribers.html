<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalDataPublisher - Multiple Subscribers Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        .test-section {
            background: #252526;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
        }
        .test-title {
            color: #569cd6;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .result {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            color: #4ec9b0;
        }
        .fail {
            color: #f48771;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .log {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .timestamp {
            color: #858585;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª GlobalDataPublisher - Multiple Subscribers Test</h1>

    <div class="test-section">
        <div class="test-title">ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</div>
        <p>í•˜ë‚˜ì˜ topic('users')ì— 3ê°œì˜ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•˜ê³ , ë°ì´í„° ë°œí–‰ ì‹œ ëª¨ë‘ í˜¸ì¶œë˜ëŠ”ì§€ ê²€ì¦</p>
    </div>

    <div class="test-section">
        <div class="test-title">ğŸ¯ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</div>
        <button onclick="runTest()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button onclick="clearLog()">ë¡œê·¸ í´ë¦¬ì–´</button>
        <div id="result" class="result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">ğŸ“ ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log" class="log"></div>
    </div>

    <script src="../Utils/fx.js"></script>
    <script>
        // Mock WKit.fetchData
        const WKit = {
            fetchData: async (page, datasetName, param) => {
                log(`WKit.fetchData called: ${datasetName}`, 'info');
                return {
                    users: [
                        { id: 1, name: 'Alice' },
                        { id: 2, name: 'Bob' },
                        { id: 3, name: 'Charlie' }
                    ]
                };
            }
        };

        // GlobalDataPublisher (ì‹¤ì œ ì½”ë“œ)
        const GlobalDataPublisher = (() => {
            const mappingTable = new Map();
            const subscriberTable = new Map();

            return {
                registerMapping({ topic, datasetInfo }) {
                    mappingTable.set(topic, datasetInfo);
                    log(`Mapping registered: topic='${topic}'`, 'success');
                    return { topic, datasetInfo };
                },

                unregisterMapping(topic) {
                    mappingTable.delete(topic);
                },

                async fetchAndPublish(topic, page) {
                    const datasetInfo = mappingTable.get(topic);
                    if (!datasetInfo) {
                        log(`âš ï¸ ë“±ë¡ë˜ì§€ ì•Šì€ topic: ${topic}`, 'fail');
                        return;
                    }

                    const data = await WKit.fetchData(page, datasetInfo.datasetName, datasetInfo.param);
                    const subs = subscriberTable.get(topic) || new Set();

                    log(`Publishing data to ${subs.size} subscriber(s) for topic='${topic}'`, 'info');

                    for (const { instance, handler } of subs) {
                        handler.call(instance, data);
                    }
                },

                subscribe(topic, instance, handler) {
                    if (!subscriberTable.has(topic)) subscriberTable.set(topic, new Set());
                    subscriberTable.get(topic).add({ instance, handler });
                    log(`Subscriber added: topic='${topic}', handler='${handler.name}'`, 'success');
                },

                unsubscribe(topic, instance) {
                    const subs = subscriberTable.get(topic);
                    if (!subs) return;
                    for (const sub of subs) {
                        if (sub.instance === instance) subs.delete(sub);
                    }
                },

                // ë””ë²„ê¹…ìš©
                getSubscriberCount(topic) {
                    const subs = subscriberTable.get(topic);
                    return subs ? subs.size : 0;
                }
            };
        })();

        // Mock Component
        class TestComponent {
            constructor(name) {
                this.name = name;
                this.callCounts = {
                    handler1: 0,
                    handler2: 0,
                    handler3: 0
                };
            }

            handler1(data) {
                this.callCounts.handler1++;
                log(`âœ… [${this.name}] handler1 called (count: ${this.callCounts.handler1})`, 'success');
                log(`   Data: ${JSON.stringify(data.users.slice(0, 1))}...`, 'info');
            }

            handler2(data) {
                this.callCounts.handler2++;
                log(`âœ… [${this.name}] handler2 called (count: ${this.callCounts.handler2})`, 'success');
                log(`   Data: ${JSON.stringify(data.users.slice(0, 1))}...`, 'info');
            }

            handler3(data) {
                this.callCounts.handler3++;
                log(`âœ… [${this.name}] handler3 called (count: ${this.callCounts.handler3})`, 'success');
                log(`   Data: ${JSON.stringify(data.users.slice(0, 1))}...`, 'info');
            }
        }

        // Logging
        const logs = [];
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            updateLog();
        }

        function updateLog() {
            const logEl = document.getElementById('log');
            logEl.innerHTML = logs.map(l => `
                <div class="log-entry">
                    <span class="timestamp">[${l.timestamp}]</span>
                    <span class="${l.type}">${l.message}</span>
                </div>
            `).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            logs.length = 0;
            updateLog();
            document.getElementById('result').innerHTML = '';
        }

        // Test
        async function runTest() {
            clearLog();
            log('ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

            // 1. ì»´í¬ë„ŒíŠ¸ ìƒì„±
            const component = new TestComponent('MyComponent');
            log('1ï¸âƒ£ ì»´í¬ë„ŒíŠ¸ ìƒì„± ì™„ë£Œ', 'success');

            // 2. êµ¬ë… ë“±ë¡ (í•œ topicì— 3ê°œ í•¸ë“¤ëŸ¬)
            log('2ï¸âƒ£ êµ¬ë… ë“±ë¡ ì‹œì‘ (users topicì— 3ê°œ í•¸ë“¤ëŸ¬)', 'info');
            const subscriptions = {
                users: ['handler1', 'handler2', 'handler3']
            };

            fx.go(
                Object.entries(subscriptions),
                fx.each(([topic, fnList]) =>
                    fx.each(fn => {
                        if (component[fn]) {
                            GlobalDataPublisher.subscribe(topic, component, component[fn]);
                        }
                    }, fnList)
                )
            );

            const subCount = GlobalDataPublisher.getSubscriberCount('users');
            log(`   âœ“ ì´ ${subCount}ê°œ í•¸ë“¤ëŸ¬ ë“±ë¡ ì™„ë£Œ`, 'success');

            // 3. ë§¤í•‘ ë“±ë¡
            log('3ï¸âƒ£ GlobalDataPublisher ë§¤í•‘ ë“±ë¡', 'info');
            GlobalDataPublisher.registerMapping({
                topic: 'users',
                datasetInfo: {
                    datasetName: 'testAPI',
                    param: { type: 'users' }
                }
            });

            // 4. ë°ì´í„° ë°œí–‰
            log('4ï¸âƒ£ ë°ì´í„° ë°œí–‰ ì‹œì‘', 'info');
            await GlobalDataPublisher.fetchAndPublish('users', {});

            // 5. ê²€ì¦
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log('5ï¸âƒ£ ê²°ê³¼ ê²€ì¦', 'info');

            const passed =
                component.callCounts.handler1 === 1 &&
                component.callCounts.handler2 === 1 &&
                component.callCounts.handler3 === 1;

            const resultEl = document.getElementById('result');

            if (passed) {
                resultEl.innerHTML = `
                    <div class="success">
                        <strong>âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!</strong><br>
                        â€¢ handler1 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler1} âœ“<br>
                        â€¢ handler2 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler2} âœ“<br>
                        â€¢ handler3 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler3} âœ“<br>
                        <br>
                        <strong>ê²°ë¡ :</strong> í•œ topicì— ì—¬ëŸ¬ ë©”ì„œë“œë¥¼ ë“±ë¡í•˜ë©´ ëª¨ë‘ ë°ì´í„°ë¥¼ ë°›ìŠµë‹ˆë‹¤!
                    </div>
                `;
                log('âœ… ëª¨ë“  í•¸ë“¤ëŸ¬ê°€ ì •í™•íˆ 1ë²ˆì”© í˜¸ì¶œë¨', 'success');
            } else {
                resultEl.innerHTML = `
                    <div class="fail">
                        <strong>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</strong><br>
                        â€¢ handler1 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler1}<br>
                        â€¢ handler2 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler2}<br>
                        â€¢ handler3 í˜¸ì¶œ íšŸìˆ˜: ${component.callCounts.handler3}<br>
                    </div>
                `;
                log('âŒ ì¼ë¶€ í•¸ë“¤ëŸ¬ê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŒ', 'fail');
            }
        }

        // ì´ˆê¸° ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. "í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
        });
    </script>
</body>
</html>
